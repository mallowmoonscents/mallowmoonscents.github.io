<!-- Follow the in-page instructions to change this file -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--Change this to what you whant (This dissplys at tab)-->
    <title>Cheese Factory | Artisan Cheeses & Seasonal Flavors</title>
    <!--Add a disscription this is what appers on the google page-->
    <meta name="description"
        content="Discover Cheese Factoryâ€™s handmade artisan cheeses, new seasonal flavors, and gift boxes. Freshly crafted and delivered to your door.">
    <!--This is key words helps your seach apperance-->
    <meta name="keywords"
        content="Cheese Factory, artisan cheese, seasonal cheese, buy cheese online, British cheese, handmade dairy products">
    <!--This link links to your home page (yourbissness.github.io)-->
    <link rel="canonical" href="https://theorangecow.github.io/cheese/">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="https://theorangecow.github.io/cheese/images/logo/logo.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
    <header>
        <!--The title at the top of the page-->
        <h1>Cheese Factory</h1>
    </header>

    <nav>
        <!--This is the nav bar if you change something here you have to change it in every file-->
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="products.html">Products</a>
        <a href="contact.html">Contact</a>
        <a href="basket.html">Basket</a>
    </nav>
    <div class="container">
        <div class="about">
            <h1 id="message"></h1>
            <a href="index.html">Go home</a>
        </div>
        <br>
    </div>
    <br>
    <script src="script.js"></script>
    <footer>
        <!--Change this to your company (You have to change this one every page)-->
        <p>&copy; 2025 Cheese Factory. All rights reserved.</p>
        <p>Made with love in the UK | <a href="contact.html">Contact Us</a></p>
        <div class="social-links">
            <!--Add your link were the _blank  (/@bob for tiktok) -->
            <a href="https://facebook.com" target="_blank" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
            <a href="https://instagram.com" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="https://x.com" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            <a href="https://tiktok.com" target="_blank" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
        </div>
    </footer>
    <script>
        const backendUrl = "https://cheese-backend-x01h.onrender.com";
        const backendUrl2 = "https://cheese-backend2.onrender.com";
        document.addEventListener("DOMContentLoaded", async () => {
            const params = new URLSearchParams(window.location.search);
            const key = params.get("key");

            if (!key) {
                document.getElementById("message").textContent = "No payment confirmation key found.";
                return;
            }

            try {
                const res = await fetch(`${backendUrl}/verify-key?key=${key}`);
                const data = await res.json();

                if (data.valid) {
                    const info = JSON.parse(localStorage.getItem("userInfo"));

                    const cart2 = JSON.parse(localStorage.getItem("cart"));
                    const itemIds = cart2.map(item => item.id);
                    const itams = itemIds.join(",");

                    const userData = {
                        name: info.name,
                        contact: info.contact,
                        itams: itams,
                        address: `${info.address.line1}, ${info.address.postcode}, ${info.address.country}`
                    };

                    try {
                        const res2 = await fetch(`${backendUrl2}/shipping`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(userData)
                        });

                        const result = await res2.json();
                        console.log("User info saved:", result);
                    } catch (err) {
                        console.error("Error saving user info:", err);
                    }

                    document.getElementById("message").textContent = "Payment confirmed.";
                    localStorage.removeItem("cart");
                } else {
                    document.getElementById("message").textContent = "Error verifying payment. Contact us";
                }
            } catch (err) {
                console.error(err);
                document.getElementById("message").textContent = "Error verifying payment. Contact us";
            }
        });


    </script>
</body>

</html>